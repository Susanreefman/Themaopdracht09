---
title: "Logbook"
author: "Susan Reefman"
date: "05/10/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(tidyr)
library(gridExtra)
library(plyr); library(dplyr)
library(grid)
library(patchwork)

```

# Research topic and dataset 

The research topic of this project is the treatment episodes of patients. 
The dataset used in this project is from the Treatment Episode Data Set (TEDS), 
an American data system of annual discharges from substance use treatment facilities.
The used dataset is a TEDS-D dataset, which means it includes discharges from substance
use treatment facilities. TEDS-D contains records on admissions of people of 12-years and older,
and includes information of admission, substance use characteristics and discharges.
The dataset includes information from patients who where at the facility in 2019.
For this project some personal and substance use characteristics information are collected from the dataset. 
In the table the variables are listed with their meaning. The type of all variables are numeric and the number of possible values is different for each variable.

data source: https://www.datafiles.samhsa.gov/dataset/teds-d-2017-ds0001-teds-d-2017-ds0001

Meaning of the numeric values in the dataset can be seen in the codebook:
https://www.datafiles.samhsa.gov/sites/default/files/field-uploads-protected/studies/TEDS-D-2019/TEDS-D-2019-datasets/TEDS-D-2019-DS0001/TEDS-D-2019-DS0001-info/TEDS-D-2019-DS0001-info-codebook_V1.pdf



```{r data, message=FALSE, warning=FALSE}
# Load dataset
load("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/tedsd_puf_2019.RData")

# get relevant data from data set
p <- "CASEID|AGE|EDUC|^EMPLOY|ALCDRUG|^SUB|^FREQ[1|2|3]|^ROUTE|^FRSTUSE|LOS|NOPRIOR|PSYPROB|DSMCRIT|REASON"
data <- df[, grep(pattern=p, colnames(df))]


codebook <- read.csv("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/codebook.csv", 
                     header = TRUE, 
                     sep = ",", 
                     na.strings = "N/A")

knitr::kable(codebook)
```



# Exploratory data analysis

## Missing data

In the dataset missing data is coded for '-9'. In this research those values
are replaced with NA.

```{r replace_mv, message=FALSE, warning=FALSE}
# replacing missing data with NA's 
data[data == -9] <- NA

```

## Variation and distribution

To get an idea of what the data includes an exploratory data analysis is done.
The barplots display the amount of patients, in age groups, when they first used 
and their frequency of use. 
Also the amount of patients and their substance use and route of administration 
are displayed in a barplot.
A boxplot is used to show the length of stay in treatment versus the type of substance use. 


## Results

With ggplot is a histogram made to depict the distribution of the age of patients in groups. 

```{r hist, message=FALSE, warning=FALSE, fig.cap="Figure 1: Histogram age of patients in groups", fig.dim = c(6, 4)}
x <- 1:12
label <- c("12-14","15–17", "18–20", "21-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-64", ">65")
ggplot(data = data, aes(x = AGE)) + 
  geom_histogram(bins = 12,
                 xlim = c(0,12),
                 ylim = c(0,1000),
                 fill = I("blue"),
                 col = I("blue"),
                 alpha = 0.5) +
  ggtitle("Distribution of age of patients") +
  xlab("Age (years)") +
  ylab("Frequency") +
  scale_x_continuous(labels=label,breaks=x)


```
The data is for used instances converted to strings instead of numeric values,
this is done for convenient plotting purposes. 
Multiple stacked barplots are made to show the distribution of values in groups.

```{r frstuse, message=FALSE, warning=FALSE}
data$frstuse <- replace(data$FRSTUSE1, data$FRSTUSE1 == 1, "<11") 
data$frstuse <- replace(data$frstuse, data$frstuse == 2, "12-14") 
data$frstuse <- replace(data$frstuse, data$frstuse == 3, "15-17")
data$frstuse <- replace(data$frstuse, data$frstuse == 4, "18-20")
data$frstuse <- replace(data$frstuse, data$frstuse == 5, "21-24")
data$frstuse <- replace(data$frstuse, data$frstuse == 6, "25-29")
data$frstuse <- replace(data$frstuse, data$frstuse == 7, ">30")

df_frstuse <- count(data$frstuse)
df_frstuse$frstuse <- c("frstuse1")
colnames(df_frstuse) <- c("age", "freq", "frstuse")

data$frstuse2 <- replace(data$FRSTUSE2, data$FRSTUSE2 == 1, "<11") 
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 2, "12-14") 
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 3, "15-17")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 4, "18-20")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 5, "21-24")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 6, "25-29")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 7, ">30")

df2_frstuse <- count(data$frstuse)
df2_frstuse$frstuse <- c("frstuse2")
colnames(df2_frstuse) <- c("age", "freq", "frstuse")

data$frstuse3 <- replace(data$FRSTUSE3, data$FRSTUSE3 == 1, "<11") 
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 2, "12-14") 
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 3, "15-17")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 4, "18-20")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 5, "21-24")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 6, "25-29")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 7, ">30")

df3_frstuse <- count(data$frstuse)
df3_frstuse$frstuse <- c("frstuse3")
colnames(df3_frstuse) <- c("age", "freq", "frstuse")

total <- rbind(df_frstuse, df2_frstuse, df3_frstuse)

p1 <- ggplot(total, aes(fill=frstuse, y=freq, x=age)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Age (years)") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))

```

```{r freq, message=FALSE, warning=FALSE}
data$freq <- replace(data$FREQ1, data$FREQ1 == 1, "No use in the past month") 
data$freq <- replace(data$freq, data$freq == 2, "Some use") 
data$freq<- replace(data$freq, data$freq == 3, "Daily use")

df_freq <- count(data$freq)
df_freq$freq_use <- c("freq1")
colnames(df_freq) <- c("frequency", "freq", "freq_use")

data$freq2 <- replace(data$FREQ2, data$FREQ2 == 1, "No use in the past month") 
data$freq2 <- replace(data$freq2, data$freq2 == 2, "Some use") 
data$freq2 <- replace(data$freq2, data$freq2 == 3, "Daily use")

df2_freq <- count(data$freq2)
df2_freq$freq_use <- c("freq2")
colnames(df2_freq) <- c("frequency", "freq", "freq_use")

data$freq3 <- replace(data$FREQ3, data$FREQ3 == 1, "No use in the past month") 
data$freq3 <- replace(data$freq3, data$freq3 == 2, "Some use") 
data$freq3 <- replace(data$freq3, data$freq3 == 3, "Daily use")

df3_freq <- count(data$freq3)
df3_freq$freq_use <- c("freq3")
colnames(df3_freq) <- c("frequency", "freq", "freq_use")

total1 <- rbind(df_freq, df2_freq, df3_freq)

p2 <- ggplot(total1, aes(fill=freq_use, y=freq, x=frequency)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Frequency of use") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))
            

```

```{r sub, message=FALSE, warning=FALSE}
data$sub <- replace(data$SUB1, data$SUB1 == 1, "None") 
data$sub <- replace(data$sub, data$sub == 2, "Alcohol") 
data$sub <- replace(data$sub, data$sub == 3, "Cocaine/crack")
data$sub <- replace(data$sub, data$sub == 4, "Marijuana/hashish")
data$sub <- replace(data$sub, data$sub == 5, "Heroin")
data$sub <- replace(data$sub, data$sub == 6, "Non-prescription methadone")
data$sub <- replace(data$sub, data$sub == 7, "Other opiates and synthetics")
data$sub <- replace(data$sub, data$sub == 8, "PCP") 
data$sub <- replace(data$sub, data$sub == 9, "Other hallucinogens")
data$sub <- replace(data$sub, data$sub == 10, "Methamphetamine")
data$sub <- replace(data$sub, data$sub == 11, "Other amphetamines")
data$sub <- replace(data$sub, data$sub == 12, "Other stimulants")
data$sub <- replace(data$sub, data$sub == 13, "Benzodiazepines")
data$sub <- replace(data$sub, data$sub == 14, "Other non-benzodiazepine tranquilizers") 
data$sub <- replace(data$sub, data$sub == 15, "Barbiturates")
data$sub <- replace(data$sub, data$sub == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub <- replace(data$sub, data$sub == 17, "Inhalants")
data$sub <- replace(data$sub, data$sub == 18, "Over-the-counter medications")
data$sub <- replace(data$sub, data$sub == 19, "Other")

df_sub <- count(data$sub)
df_sub$sub <- c("sub1")
colnames(df_sub) <- c("substance", "freq", "sub")

data$sub2 <- replace(data$SUB2, data$SUB2 == 1, "None") 
data$sub2 <- replace(data$sub2, data$sub2 == 2, "Alcohol") 
data$sub2 <- replace(data$sub2, data$sub2 == 3, "Cocaine/crack")
data$sub2 <- replace(data$sub2, data$sub2 == 4, "Marijuana/hashish")
data$sub2 <- replace(data$sub2, data$sub2 == 5, "Heroin")
data$sub2 <- replace(data$sub2, data$sub2 == 6, "Non-prescription methadone")
data$sub2 <- replace(data$sub2, data$sub2 == 7, "Other opiates and synthetics")
data$sub2 <- replace(data$sub2, data$sub2 == 8, "PCP") 
data$sub2 <- replace(data$sub2, data$sub2 == 9, "Other hallucinogens")
data$sub2 <- replace(data$sub2, data$sub2 == 10, "Methamphetamine")
data$sub2 <- replace(data$sub2, data$sub2 == 11, "Other amphetamines")
data$sub2 <- replace(data$sub2, data$sub2 == 12, "Other stimulants")
data$sub2 <- replace(data$sub2, data$sub2 == 13, "Benzodiazepines")
data$sub2 <- replace(data$sub2, data$sub2 == 14, "Other non-benzodiazepine tranquilizers") 
data$sub2 <- replace(data$sub2, data$sub2 == 15, "Barbiturates")
data$sub2 <- replace(data$sub2, data$sub2 == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub2 <- replace(data$sub2, data$sub2 == 17, "Inhalants")
data$sub2 <- replace(data$sub2, data$sub2 == 18, "Over-the-counter medications")
data$sub2 <- replace(data$sub2, data$sub2 == 19, "Other")

df2_sub <- count(data$sub2)
df2_sub$sub <- c("sub2")
colnames(df2_sub) <- c("substance", "freq", "sub")

data$sub3 <- replace(data$SUB3, data$SUB3 == 1, "None") 
data$sub3 <- replace(data$sub3, data$sub3 == 2, "Alcohol") 
data$sub3 <- replace(data$sub3, data$sub3 == 3, "Cocaine/crack")
data$sub3 <- replace(data$sub3, data$sub3 == 4, "Marijuana/hashish")
data$sub3 <- replace(data$sub3, data$sub3 == 5, "Heroin")
data$sub3 <- replace(data$sub3, data$sub3 == 6, "Non-prescription methadone")
data$sub3 <- replace(data$sub3, data$sub3 == 7, "Other opiates and synthetics")
data$sub3 <- replace(data$sub3, data$sub3 == 8, "PCP") 
data$sub3 <- replace(data$sub3, data$sub3 == 9, "Other hallucinogens")
data$sub3 <- replace(data$sub3, data$sub3 == 10, "Methamphetamine")
data$sub3 <- replace(data$sub3, data$sub3 == 11, "Other amphetamines")
data$sub3 <- replace(data$sub3, data$sub3 == 12, "Other stimulants")
data$sub3 <- replace(data$sub3, data$sub3 == 13, "Benzodiazepines")
data$sub3 <- replace(data$sub3, data$sub3 == 14, "Other non-benzodiazepine tranquilizers") 
data$sub3 <- replace(data$sub3, data$sub3 == 15, "Barbiturates")
data$sub3 <- replace(data$sub3, data$sub3 == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub3 <- replace(data$sub3, data$sub3 == 17, "Inhalants")
data$sub3 <- replace(data$sub3, data$sub3 == 18, "Over-the-counter medications")
data$sub3 <- replace(data$sub3, data$sub3 == 19, "Other")

df3_sub <- count(data$sub3)
df3_sub$sub <- c("sub3")
colnames(df3_sub) <- c("substance", "freq", "sub")

total2 <- rbind(df_sub, df2_sub, df3_sub)

p3 <- ggplot(total2, aes(fill=sub, y=freq, x=substance)) + 
            geom_bar(position="stack", stat="identity")+
            xlab("Substance used") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle =90)) + 
            ggtitle("Distribution of substance use of patients")

```

```{r route, message=FALSE, warning=FALSE}
data$route <- replace(data$ROUTE1, data$ROUTE1 == 1, "Oral") 
data$route <- replace(data$route, data$route == 2, "Smoking") 
data$route <- replace(data$route, data$route == 3, "Inhalation")
data$route <- replace(data$route, data$route == 4, "Injection") 
data$route <- replace(data$route, data$route == 5, "Other")

df_route <- count(data$route)
df_route$freq_route <- c("route1")
colnames(df_route) <- c("route", "freq", "freq_route")

data$route2 <- replace(data$ROUTE2, data$ROUTE2 == 1, "Oral") 
data$route2 <- replace(data$route2, data$route2 == 2, "Smoking") 
data$route2 <- replace(data$route2, data$route2 == 3, "Inhalation")
data$route2 <- replace(data$route2, data$route2 == 4, "Injection") 
data$route2 <- replace(data$route2, data$route2 == 5, "Other")

df2_route <- count(data$route2)
df2_route$freq_route2 <- c("route2")
colnames(df2_route) <- c("route", "freq", "freq_route")

data$route3 <- replace(data$ROUTE3, data$ROUTE3 == 1, "Oral") 
data$route3 <- replace(data$route3, data$route3 == 2, "Smoking") 
data$route3 <- replace(data$route3, data$route3 == 3, "Inhalation")
data$route3 <- replace(data$route3, data$route3 == 4, "Injection") 
data$route3 <- replace(data$route3, data$route3 == 5, "Other")

df3_route <- count(data$route3)
df3_route$freq_route3 <- c("route3")
colnames(df3_route) <- c("route", "freq", "freq_route")

total3 <- rbind(df_route, df2_route, df3_route)

p4 <- ggplot(total3, aes(fill=freq_route, y=freq, x=route)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Route of administration") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))
  
```


```{r barplots_figure2, message=FALSE, warning=FALSE, fig.cap="Figure 2: Stacked barplots of use characteristics of patients", fig.dim=c(6,20)}
grid.arrange(p1, p2, p4, top=textGrob("Distribution of use characteristics of patients"), ncol = 1)

```

```{r barplots_figure3, fig.cap="Figure 3: Stacked barplot of substance use of patients", fig.dim = c(8,4)}
p3 
```


```{r boxplot_figure4, fig.cap="Figure 4: Boxplot length of stay in treatment in days by the substance use type of patients",  fig.dim = c(6, 4)}
data$type_drug <- replace(data$ALCDRUG, data$ALCDRUG == 1, "Alcohol only") 
data$type_drug <- replace(data$type_drug, data$type_drug == 2, "Other drugs only") 
data$type_drug <- replace(data$type_drug, data$type_drug == 3, "Alcohol and other drugs")
data$type_drug <- replace(data$type_drug, data$type_drug == 0, "None")
y <- 1:37
ggplot(data = data, aes(factor(x=type_drug, level = c("None", "Alcohol only", "Other drugs only", "Alcohol and other drugs")), y=LOS)) +
  geom_boxplot() +
  scale_y_continuous(labels = c(1:30,"31-45","46-60", "61-90", "91-120", "121-180", "181-365", ">365"),
                     breaks=y) +
  ylab("Length of stay (days)") +
  xlab("Type of substance use") +
  ggtitle("Length of stay in treatment by substance use type")
  
```

```{r}
# Length Of Stay data converted
data$los <- as.character(data$LOS)
data$los <- replace(data$los, data$los == 31, "31-45") 
data$los <- replace(data$los, data$los == 32, "46-60") 
data$los <- replace(data$los, data$los == 33, "61-90") 
data$los <- replace(data$los, data$los == 34, "91-120") 
data$los <- replace(data$los, data$los == 35, "121-180") 
data$los <- replace(data$los, data$los == 36, "181-365") 
data$los <- replace(data$los, data$los == 37, ">365") 
```



# Cleaning dataset

Because the dataset is very large and most of the data is not included in this project.
Only the characteristics of the use of patients is necessary, which include: Type of use (alcohol, drugs or both), the substance of use, the frequency of use and the age of first use. The length of stay is also necessary in this project. 
Because the dataset is this large, the patients which have information that is not available is removed from the dataset. This includes around 200.000 patients, the dataset still includes more than 1.5 million patients. Removing the missing values makes it also easier for the machine learning algorithm to classify instances. 
Thereafter a sample of the dataset is taken. Both the dataset and the sample are written to csv files, to 
be uploaded to Weka. 

```{r}
pat <- "type_drug|sub$|freq$|frstuse$|los"

# get relevant data from dataset
dataset <- data[, grep(pattern=pat, colnames(data))]

# remove rows with NA's
dataset <- na.omit(dataset)

dataset_sample <- sample_n(dataset, 1520681/10) 

```



```{r}
# Write datasets to csv files
write.csv(dataset, file = "dataset_thema09.csv")

write.csv(dataset_sample, file = "dataset_sample_thema09.csv")


```


# Weka

## Weka Explorer 

The csv files are uploaded in the Weka Explorer. To validate the sample, both datasets were
investigated with the ZeroR machine learning algorithm. In the table beneath, can be seen
that the percentage of instances (in)correctly classified are not significant different.
Taking the sample as the dataset to investigate further.
The performance of standard machine learning algorithms was investigated. The classifier and
attribute investigated were noted as well as the percentages (in)correctly classified instances. 

```{r}
weka <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/weka.csv", 
                  sep = ',',
                  header = T)

knitr::kable(weka)
```

## Weka Experimenter

Using the Weka Experimenter machine learning algorithms with 10-fold cross-validations were performed. 
Results of each machine learning algorithm is separately saved in the Weka_results folder.


```{r}
pat <- "Key_Run|Key_Fold|Percent_correct|Percent_incorrect|True_positive_rate|False_positive_rate|True_negative_rate|False_negative_rate|^Elapsed"

# Read table from csv file
zeror <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/ZeroR.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
zeror <- zeror[, grep(pattern=pat, colnames(zeror))]

knitr::kable(head(zeror))


```

```{r}
# Read table from csv file
oner <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/OneR.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
oner <- oner[, grep(pattern=pat, colnames(oner))]

knitr::kable(head(oner))




```


```{r}
# Read table from csv file
naivebayes <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/naivebayes.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
naivebayes <- naivebayes[, grep(pattern=pat, colnames(naivebayes))]

knitr::kable(head(naivebayes))



```

```{r}
# Read table from csv file
Ikb <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/Ikb.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
Ikb <- Ikb[, grep(pattern=pat, colnames(Ikb))]

knitr::kable(head(Ikb))

```


```{r}
# Read table from csv file
SL <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/SimpleLogistics.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
SL <- SL[, grep(pattern=pat, colnames(SL))]

knitr::kable(head(SL))

```

```{r}
# Read table from csv file
smo <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/SMO.csv", 
                        sep = ',',
                        header = T)

# Get relevant information
smo <- smo[, grep(pattern=pat, colnames(smo))]

knitr::kable(head(smo))


```



## Optimize algorithms

For further optimalization Naive Bayes and SimpleLogistics algorithms are choosen. 
First Naive Bayes is investigated.
Changing to the `Train/Test Percentage Split (data randomized)` test option:
With 10 runs and the split percentage ranging from 40 to 90%, the algorithm
classifies between the 70.66% (40% split percentage) and 70.74% (66% split percentage).
This is not better than the original Naive Bayes algorithm. 
Thereafter the k-fold cross-validation was tested. But also here, no optimalization 
by changing the number of folds higher or lower.

Moving on to the SimpleLogistics algorithm:
Changing again the `Train/Test Percentage Split (data randomized)` test option:
With 10 runs and the split percentage ranging from 40 to 90% the algorithm, the
algorithm classified every time 72% of the instances correctly. This is not worse, 
but also no optimalization. 
Optimalization was achieved with increasing the number of folds with the k-fold cross-validation
test-option. With 15-folds, 75% of the instances were correctly but the time performing
the algorithm doubled, so in general would the increase not be sufficient. 
 

```{r}
meta <- c("Bagging", "Stacking", "Boosting") #rows
training_correct <- c("43.3%", "13.6%", "13.6%") 
training_incorrect <- c("56.7%", "86.4%", "86.4%") 

fold_correct <- c("9.6%", "13.6%", "13.6%")
fold_incorrect <- c("90.3%","86.4%", "86.4%")

training <- data.frame(training_correct, training_incorrect)
row.names(training) <- meta
colnames(training) <- c("Correctly classified", "Incorrectly classified")
training


fold <- data.frame(fold_correct, fold_incorrect)
row.names(fold) <- meta
colnames(fold) <- c("Correctly classified", "Incorrectly classified")
fold
```


## Visualizing

Visualizing the results in a ROC curve, figure 5, can be done in the Explorer.
By running the Naive Bayes algorithm with 10-fold cross-validation, being the best model,
the ROC curve can be visualized. 
The area under the curve is 0.6664

Creating a learning curve can be done in the advanced mode of the Experimenter. For destination choose `CSVResultListener` and for `Result generator`, `RandomSplitResultProducer` with again 90.0 as `trainPercent`.The `splitEvaluator` is set to `CostSensitiveClassifier` which is set to the Naive Bayes classifier. After taking the data and error rate out of Weka a learning curve is made. 
As you can see in figure 6 the bottom plot the algorithm learns most when 90% of the data is used. The algorithm starts to learn slow when less than 20% is used.

<!-- #!["figure 5: ROC curve"](~/Bio-informatica/BFV3/Semester1/Themaopdracht09/ROC.jpg)

#!["figure 6: Learning curve"](~/Bio-informatica/BFV3/Semester1/Themaopdracht09/LC.jpg) --> 




