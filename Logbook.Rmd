---
title: "Logbook"
author: "Susan Reefman"
date: "05/10/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(tidyr)
library(gridExtra)
library(plyr); library(dplyr)
library(grid)
library(patchwork)

```

# Research topic and dataset 

The research topic of this project is the treatment episodes of patients. 
The dataset used in this project is from the Treatment Episode Data Set (TEDS), 
an American data system of annual discharges from substance use treatment facilities.
The used dataset is a TEDS-D dataset, which means it includes discharges from substance
use treatment facilities. TEDS-D contains records on admissions of people of 12-years and older,
and includes information of admission, substance use characteristics and discharges.
The dataset includes information from patients who where at the facility in 2019.
For this project some personal and substance use characteristics information are collected from the dataset. 
In the table the variables are listed with their meaning. The type of all variables are numeric and the number of possible values 
is different for each variable.

data source: https://www.datafiles.samhsa.gov/dataset/teds-d-2017-ds0001-teds-d-2017-ds0001


```{r data}
load("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/tedsd_puf_2019.RData")

p <- "CASEID|AGE|EDUC|^EMPLOY|ALCDRUG|^SUB|^FREQ[1|2|3]|^ROUTE|^FRSTUSE|LOS|NOPRIOR|PSYPROB|DSMCRIT|REASON"

# get relevant data from data set
data <- df[, grep(pattern=p, colnames(df))]

codebook <- read.csv("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/codebook.csv", 
                     header = TRUE, 
                     sep = ",", 
                     na.strings = "N/A")

knitr::kable(codebook)
```

With this dataset a model can be made. In this project is researched whether the length of treatment can be predicted. 
The model is made by the following question: "Can the length of treatment be predicted 
based on the substance use, frequency of use and the age at first use by using machine learning?"
To answer this question information is collected from the dataset. The personal information
about the patients that is used is case id, age, education and employment status.
Other information is about substance characteristics, for example; substance use type, 
substance use at admission and discharge and route of administration.
The information about treatment episodes are also covered. This includes length
of stay in treatment, number of previous substance treatment episodes and reason of 
discharge. 

# Exploratory data analysis

## Missing data

In the dataset missing data is coded for '-9'. In this research those values
are replaced with NA.

```{r}
# replacing missing data with NA's 
data[data == -9] <- NA

```

## Variation and distribution


To get an idea of what the data includes a couple histograms are made (see results).
The histograms display the amount of patients, in age groups, when they first used 
and their frequency of use. 
Also the amount of patients and their substance use are displayed in a histogram. 
A boxplot is used to show the length of stay in treatment versus the type of substance use. 


## Results

In figure 1 is the age of patients shown. The age of patients is divided in
groups of around 4 years. Most patients are between 25 and 39 years old. 
The age of patients seems like a normal distrubution.


```{r message=FALSE, warning=FALSE, fig.cap="Figure 1: Histogram age of patients in groups", fig.dim = c(6, 4)}
x <- 1:12
label <- c("12-14","15–17", "18–20", "21-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-64", ">65")
ggplot(data = data, aes(x = AGE)) + 
  geom_histogram(bins = 12,
                 xlim = c(0,12),
                 ylim = c(0,1000),
                 fill = I("blue"),
                 col = I("blue"),
                 alpha = 0.5) +
  ggtitle("Distribution of age of patients") +
  xlab("Age (years)") +
  ylab("Frequency") +
  scale_x_continuous(labels=label,breaks=x)


```


Figure 2 .... 

```{r frstuse, message=FALSE, warning=FALSE}
data$frstuse <- replace(data$FRSTUSE1, data$FRSTUSE1 == 1, "<11") 
data$frstuse <- replace(data$frstuse, data$frstuse == 2, "12-14") 
data$frstuse <- replace(data$frstuse, data$frstuse == 3, "15-17")
data$frstuse <- replace(data$frstuse, data$frstuse == 4, "18-20")
data$frstuse <- replace(data$frstuse, data$frstuse == 5, "21-24")
data$frstuse <- replace(data$frstuse, data$frstuse == 6, "25-29")
data$frstuse <- replace(data$frstuse, data$frstuse == 7, ">30")

df_frstuse <- count(data$frstuse)
df_frstuse$frstuse <- c("frstuse1")
colnames(df_frstuse) <- c("age", "freq", "frstuse")

data$frstuse2 <- replace(data$FRSTUSE2, data$FRSTUSE2 == 1, "<11") 
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 2, "12-14") 
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 3, "15-17")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 4, "18-20")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 5, "21-24")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 6, "25-29")
data$frstuse2 <- replace(data$frstuse2, data$frstuse2 == 7, ">30")

df2_frstuse <- count(data$frstuse)
df2_frstuse$frstuse <- c("frstuse2")
colnames(df2_frstuse) <- c("age", "freq", "frstuse")

data$frstuse3 <- replace(data$FRSTUSE3, data$FRSTUSE3 == 1, "<11") 
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 2, "12-14") 
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 3, "15-17")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 4, "18-20")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 5, "21-24")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 6, "25-29")
data$frstuse3 <- replace(data$frstuse3, data$frstuse3 == 7, ">30")

df3_frstuse <- count(data$frstuse)
df3_frstuse$frstuse <- c("frstuse3")
colnames(df3_frstuse) <- c("age", "freq", "frstuse")

total <- rbind(df_frstuse, df2_frstuse, df3_frstuse)

p1 <- ggplot(total, aes(fill=frstuse, y=freq, x=age)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Age (years)") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))

```

```{r freq, message=FALSE, warning=FALSE}
data$freq <- replace(data$FREQ1, data$FREQ1 == 1, "No use in the past month") 
data$freq <- replace(data$freq, data$freq == 2, "Some use") 
data$freq<- replace(data$freq, data$freq == 3, "Daily use")

df_freq <- count(data$freq)
df_freq$freq_use <- c("freq1")
colnames(df_freq) <- c("frequency", "freq", "freq_use")

data$freq2 <- replace(data$FREQ2, data$FREQ2 == 1, "No use in the past month") 
data$freq2 <- replace(data$freq2, data$freq2 == 2, "Some use") 
data$freq2 <- replace(data$freq2, data$freq2 == 3, "Daily use")

df2_freq <- count(data$freq2)
df2_freq$freq_use <- c("freq2")
colnames(df2_freq) <- c("frequency", "freq", "freq_use")

data$freq3 <- replace(data$FREQ3, data$FREQ3 == 1, "No use in the past month") 
data$freq3 <- replace(data$freq3, data$freq3 == 2, "Some use") 
data$freq3 <- replace(data$freq3, data$freq3 == 3, "Daily use")

df3_freq <- count(data$freq3)
df3_freq$freq_use <- c("freq3")
colnames(df3_freq) <- c("frequency", "freq", "freq_use")

total1 <- rbind(df_freq, df2_freq, df3_freq)

p2 <- ggplot(total1, aes(fill=freq_use, y=freq, x=frequency)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Frequency of use") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))
            

```

```{r sub}
data$sub <- replace(data$SUB1, data$SUB1 == 1, "None") 
data$sub <- replace(data$sub, data$sub == 2, "Alcohol") 
data$sub <- replace(data$sub, data$sub == 3, "Cocaine/crack")
data$sub <- replace(data$sub, data$sub == 4, "Marijuana/hashish")
data$sub <- replace(data$sub, data$sub == 5, "Heroin")
data$sub <- replace(data$sub, data$sub == 6, "Non-prescription methadone")
data$sub <- replace(data$sub, data$sub == 7, "Other opiates and synthetics")
data$sub <- replace(data$sub, data$sub == 8, "PCP") 
data$sub <- replace(data$sub, data$sub == 9, "Other hallucinogens")
data$sub <- replace(data$sub, data$sub == 10, "Methamphetamine")
data$sub <- replace(data$sub, data$sub == 11, "Other amphetamines")
data$sub <- replace(data$sub, data$sub == 12, "Other stimulants")
data$sub <- replace(data$sub, data$sub == 13, "Benzodiazepines")
data$sub <- replace(data$sub, data$sub == 14, "Other non-benzodiazepine tranquilizers") 
data$sub <- replace(data$sub, data$sub == 15, "Barbiturates")
data$sub <- replace(data$sub, data$sub == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub <- replace(data$sub, data$sub == 17, "Inhalants")
data$sub <- replace(data$sub, data$sub == 18, "Over-the-counter medications")
data$sub <- replace(data$sub, data$sub == 19, "Other")

df_sub <- count(data$sub)
df_sub$sub <- c("sub1")
colnames(df_sub) <- c("substance", "freq", "sub")

data$sub2 <- replace(data$SUB2, data$SUB2 == 1, "None") 
data$sub2 <- replace(data$sub2, data$sub2 == 2, "Alcohol") 
data$sub2 <- replace(data$sub2, data$sub2 == 3, "Cocaine/crack")
data$sub2 <- replace(data$sub2, data$sub2 == 4, "Marijuana/hashish")
data$sub2 <- replace(data$sub2, data$sub2 == 5, "Heroin")
data$sub2 <- replace(data$sub2, data$sub2 == 6, "Non-prescription methadone")
data$sub2 <- replace(data$sub2, data$sub2 == 7, "Other opiates and synthetics")
data$sub2 <- replace(data$sub2, data$sub2 == 8, "PCP") 
data$sub2 <- replace(data$sub2, data$sub2 == 9, "Other hallucinogens")
data$sub2 <- replace(data$sub2, data$sub2 == 10, "Methamphetamine")
data$sub2 <- replace(data$sub2, data$sub2 == 11, "Other amphetamines")
data$sub2 <- replace(data$sub2, data$sub2 == 12, "Other stimulants")
data$sub2 <- replace(data$sub2, data$sub2 == 13, "Benzodiazepines")
data$sub2 <- replace(data$sub2, data$sub2 == 14, "Other non-benzodiazepine tranquilizers") 
data$sub2 <- replace(data$sub2, data$sub2 == 15, "Barbiturates")
data$sub2 <- replace(data$sub2, data$sub2 == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub2 <- replace(data$sub2, data$sub2 == 17, "Inhalants")
data$sub2 <- replace(data$sub2, data$sub2 == 18, "Over-the-counter medications")
data$sub2 <- replace(data$sub2, data$sub2 == 19, "Other")

df2_sub <- count(data$sub2)
df2_sub$sub <- c("sub2")
colnames(df2_sub) <- c("substance", "freq", "sub")

data$sub3 <- replace(data$SUB3, data$SUB3 == 1, "None") 
data$sub3 <- replace(data$sub3, data$sub3 == 2, "Alcohol") 
data$sub3 <- replace(data$sub3, data$sub3 == 3, "Cocaine/crack")
data$sub3 <- replace(data$sub3, data$sub3 == 4, "Marijuana/hashish")
data$sub3 <- replace(data$sub3, data$sub3 == 5, "Heroin")
data$sub3 <- replace(data$sub3, data$sub3 == 6, "Non-prescription methadone")
data$sub3 <- replace(data$sub3, data$sub3 == 7, "Other opiates and synthetics")
data$sub3 <- replace(data$sub3, data$sub3 == 8, "PCP") 
data$sub3 <- replace(data$sub3, data$sub3 == 9, "Other hallucinogens")
data$sub3 <- replace(data$sub3, data$sub3 == 10, "Methamphetamine")
data$sub3 <- replace(data$sub3, data$sub3 == 11, "Other amphetamines")
data$sub3 <- replace(data$sub3, data$sub3 == 12, "Other stimulants")
data$sub3 <- replace(data$sub3, data$sub3 == 13, "Benzodiazepines")
data$sub3 <- replace(data$sub3, data$sub3 == 14, "Other non-benzodiazepine tranquilizers") 
data$sub3 <- replace(data$sub3, data$sub3 == 15, "Barbiturates")
data$sub3 <- replace(data$sub3, data$sub3 == 16, "Other non-barbiturate sedatives or hypnotics")
data$sub3 <- replace(data$sub3, data$sub3 == 17, "Inhalants")
data$sub3 <- replace(data$sub3, data$sub3 == 18, "Over-the-counter medications")
data$sub3 <- replace(data$sub3, data$sub3 == 19, "Other")

df3_sub <- count(data$sub3)
df3_sub$sub <- c("sub3")
colnames(df3_sub) <- c("substance", "freq", "sub")

total2 <- rbind(df_sub, df2_sub, df3_sub)

p3 <- ggplot(total2, aes(fill=sub, y=freq, x=substance)) + 
            geom_bar(position="stack", stat="identity")+
            xlab("Substance used") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle =90))

```

```{r route, message=FALSE, warning=FALSE}
data$route <- replace(data$ROUTE1, data$ROUTE1 == 1, "Oral") 
data$route <- replace(data$route, data$route == 2, "Smoking") 
data$route <- replace(data$route, data$route == 3, "Inhalation")
data$route <- replace(data$route, data$route == 4, "Injection") 
data$route <- replace(data$route, data$route == 5, "Other")

df_route <- count(data$route)
df_route$freq_route <- c("route1")
colnames(df_route) <- c("route", "freq", "freq_route")

data$route2 <- replace(data$ROUTE2, data$ROUTE2 == 1, "Oral") 
data$route2 <- replace(data$route2, data$route2 == 2, "Smoking") 
data$route2 <- replace(data$route2, data$route2 == 3, "Inhalation")
data$route2 <- replace(data$route2, data$route2 == 4, "Injection") 
data$route2 <- replace(data$route2, data$route2 == 5, "Other")

df2_route <- count(data$route2)
df2_route$freq_route2 <- c("route2")
colnames(df2_route) <- c("route", "freq", "freq_route")

data$route3 <- replace(data$ROUTE3, data$ROUTE3 == 1, "Oral") 
data$route3 <- replace(data$route3, data$route3 == 2, "Smoking") 
data$route3 <- replace(data$route3, data$route3 == 3, "Inhalation")
data$route3 <- replace(data$route3, data$route3 == 4, "Injection") 
data$route3 <- replace(data$route3, data$route3 == 5, "Other")

df3_route <- count(data$route3)
df3_route$freq_route3 <- c("route3")
colnames(df3_route) <- c("route", "freq", "freq_route")

total3 <- rbind(df_route, df2_route, df3_route)

p4 <- ggplot(total3, aes(fill=freq_route, y=freq, x=route)) + 
            geom_bar(position="stack", stat="identity") +
            xlab("Route of administration") +
            ylab("Patients") +
            theme(axis.text.x = element_text(angle = 90))
  
```


```{r , fig.cap="Figure 2: Stacked barplots of use characteristics of patients"}
grid.arrange(p1, p2, p3, p4, top=textGrob("Histograms of 4 Variables"), ncol = 2)

```

Figure 3:

```{r fig.cap="Figure 3: Boxplot length of stay in treatment in days by the substance use type of patients",  fig.dim = c(6, 4)}
data$type_drug <- replace(data$ALCDRUG, data$ALCDRUG == 1, "Alcohol only") 
data$type_drug <- replace(data$type_drug, data$type_drug == 2, "Other drugs only") 
data$type_drug <- replace(data$type_drug, data$type_drug == 3, "Alcohol and other drugs")
data$type_drug <- replace(data$type_drug, data$type_drug == 0, "None")
y <- 1:37
ggplot(data = data, aes(factor(x=type_drug, level = c("None", "Alcohol only", "Other drugs only", "Alcohol and other drugs")), y=LOS)) +
  geom_boxplot() +
  scale_y_continuous(labels = c(1:30,"31-45","46-60", "61-90", "91-120", "121-180", "181-365", ">365"),
                     breaks=y) +
  ylab("Length of stay (days)") +
  xlab("Type of substance use") +
  ggtitle("Length of stay in treatment by substance use type")
  
```


# Cleaning dataset

Because the dataset is very large and most of the data is not included in this project.
Only the characteristics of the use of patients is necessary, which include: Type of use (alcohol, drugs or both), the substance of use, the frequency of use and the age of first use. The length of stay is also necessary in this project. 
Because the dataset is this large, the patients which have information that is not available is removed from the dataset. This includes around 200.000 patients, the dataset still includes more than 1.5 million patients. 

```{r}
pat <- "type_drug|sub$|freq$|frstuse$|los"

# get relevant data from dataset
dataset <- data[, grep(pattern=pat, colnames(data))]

# remove rows with NA's
dataset <- na.omit(dataset)


dataset_weka <- sample_n(dataset, 1520681/3) 

```

```{r}
write.csv(dataset_weka, file = "dataset_thema09.csv")

```

After that the cleaned dataset is written to a csv file. 
```{r}
# Write dataset to csv file
write.csv(dataset, file = "dataset_thema09.csv")
```


# Weka

## Weka Explorer 

The csv file is uploaded in the Weka Explorer. 
The performance of standard machine learning algorithms was investigated. The classifier and
attribute investigated were noted as well as the percentages (in)correctly classified instances. 

```{r}
weka <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/weka.csv", 
                  sep = ',',
                  header = T)

knitr::kable(weka)
```

## Weka Experimenter

Using the Weka Experimenter machine learning algorithms with 10-fold cross-validations were performed. 
Results of each machine learning algorithm is separately saved in the Weka_results folder.


```{r}
pat <- "Key_Run|Key_Fold|Percent_correct|Percent_incorrect|True_positive_rate|False_positive_rate|True_negative_rate|False_negative_rate|^Elapsed"

zeror <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/ZeroR.csv", 
                        sep = ',',
                        header = T)

zeror <- zeror[, grep(pattern=pat, colnames(zeror))]

knitr::kable(zeror)

```

```{r}
oner <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/OneR.csv", 
                        sep = ',',
                        header = T)

oner <- oner[, grep(pattern=pat, colnames(oner))]

knitr::kable(oner)

```


```{r}
naivebayes <- read.table("~/Bio-informatica/BFV3/Semester1/Themaopdracht09/Weka_results/naivebayes.csv", 
                        sep = ',',
                        header = T)

naivebayes <- naivebayes[, grep(pattern=pat, colnames(naivebayes))]

knitr::kable(naivebayes)

```




```{r}

```


```{r}

```










